{"version":3,"file":"DepthOfField.js","sources":["../../src/effects/DepthOfField.tsx"],"sourcesContent":["import { DepthOfFieldEffect, MaskFunction } from 'postprocessing'\nimport { Ref, forwardRef, useMemo, useEffect, useContext } from 'react'\nimport { ReactThreeFiber } from '@react-three/fiber'\nimport { type DepthPackingStrategies, type Texture, Vector3 } from 'three'\nimport { EffectComposerContext } from '../EffectComposer'\n\ntype DOFProps = ConstructorParameters<typeof DepthOfFieldEffect>[1] &\n  Partial<{\n    target: ReactThreeFiber.Vector3\n    depthTexture: {\n      texture: Texture\n      // TODO: narrow to DepthPackingStrategies\n      packing: number\n    }\n    // TODO: not used\n    blur: number\n  }>\n\nexport const DepthOfField = forwardRef(function DepthOfField(\n  {\n    blendFunction,\n    worldFocusDistance,\n    worldFocusRange,\n    focusDistance,\n    focusRange,\n    focalLength,\n    bokehScale,\n    resolutionScale,\n    resolutionX,\n    resolutionY,\n    width,\n    height,\n    target,\n    depthTexture,\n    ...props\n  }: DOFProps,\n  ref: Ref<DepthOfFieldEffect>\n) {\n  const { camera } = useContext(EffectComposerContext)\n  const autoFocus = target != null\n  const effect = useMemo(() => {\n    const effect = new DepthOfFieldEffect(camera, {\n      blendFunction,\n      worldFocusDistance,\n      worldFocusRange,\n      focusDistance,\n      focusRange,\n      focalLength,\n      bokehScale,\n      resolutionScale,\n      resolutionX,\n      resolutionY,\n      width,\n      height,\n    })\n    // Creating a target enables autofocus, R3F will set via props\n    if (autoFocus) effect.target = new Vector3()\n    // Depth texture for depth picking with optional packing strategy\n    if (depthTexture) effect.setDepthTexture(depthTexture.texture, depthTexture.packing as DepthPackingStrategies)\n    // Temporary fix that restores DOF 6.21.3 behavior, everything since then lets shapes leak through the blur\n    const maskMaterial = (effect as any).maskPass.getFullscreenMaterial()\n    maskMaterial.maskFunction = MaskFunction.MULTIPLY_RGB_SET_ALPHA\n    return effect\n  }, [\n    camera,\n    blendFunction,\n    worldFocusDistance,\n    worldFocusRange,\n    focusDistance,\n    focusRange,\n    focalLength,\n    bokehScale,\n    resolutionScale,\n    resolutionX,\n    resolutionY,\n    width,\n    height,\n    autoFocus,\n    depthTexture,\n  ])\n\n  useEffect(() => {\n    return () => {\n      effect.dispose()\n    }\n  }, [effect])\n\n  return <primitive {...props} ref={ref} object={effect} target={target} />\n})\n"],"names":["DepthOfField","effect"],"mappings":";;;;;AAkBa,MAAA,eAAe,WAAW,SAASA,cAC9C;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA,GAAG;AACL,GACA,KACA;AACA,QAAM,EAAE,OAAA,IAAW,WAAW,qBAAqB;AACnD,QAAM,YAAY,UAAU;AACtB,QAAA,SAAS,QAAQ,MAAM;AACrBC,UAAAA,UAAS,IAAI,mBAAmB,QAAQ;AAAA,MAC5C;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACD;AAEG,QAAA;AAAWA,cAAO,SAAS,IAAI;AAE/B,QAAA;AAAcA,cAAO,gBAAgB,aAAa,SAAS,aAAa,OAAiC;AAEvG,UAAA,eAAgBA,QAAe,SAAS,sBAAsB;AACpE,iBAAa,eAAe,aAAa;AAClCA,WAAAA;AAAAA,EAAA,GACN;AAAA,IACD;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA,CACD;AAED,YAAU,MAAM;AACd,WAAO,MAAM;AACX,aAAO,QAAQ;AAAA,IAAA;AAAA,EACjB,GACC,CAAC,MAAM,CAAC;AAEX,6BAAQ,aAAW,EAAA,GAAG,OAAO,KAAU,QAAQ,QAAQ,OAAgB,CAAA;AACzE,CAAC;"}